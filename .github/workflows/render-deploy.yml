# ğŸš€ Render Deployment Workflow - Simple & Reliable
name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  # ============================================================================
  # ğŸ—ï¸ BUILD JOB - Reuse from main CI
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“… Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“ˆ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --no-audit --no-fund

    - name: ğŸ”¨ Build application
      run: |
        echo "ğŸ”¨ Building client and server separately..."
        npm run build:client
        npm run build:server
        echo "âœ… Build completed successfully"

    - name: ğŸ“Š Build summary
      run: |
        echo "âœ… Build completed successfully"
        echo "ğŸ“¦ Build artifacts ready for deployment"

  # ============================================================================
  # ğŸš€ RENDER DEPLOYMENT - Production Ready
  # ============================================================================
  deploy-render:
    name: ğŸš€ Deploy to Render
    needs: build
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.RENDER_SERVICE_URL }}
    
    steps:
    - name: ğŸ“… Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}

    - name: â³ Wait for deployment
      run: |
        echo "â³ Waiting for Render service to be ready..."
        sleep 45
        
    - name: ğŸ” Health check
      run: |
        echo "ğŸ” Performing health check..."
        SERVICE_URL="${{ secrets.RENDER_SERVICE_URL }}"
        
        # Try multiple endpoints
        ENDPOINTS=("/health" "/api/health" "/")
        
        for endpoint in "${ENDPOINTS[@]}"; do
          echo "Testing: ${SERVICE_URL}${endpoint}"
          if curl -f -s "${SERVICE_URL}${endpoint}" > /dev/null 2>&1; then
            echo "âœ… Health check passed: ${endpoint}"
            break
          else
            echo "âš ï¸ Health check failed: ${endpoint}"
          fi
        done

    - name: ğŸ“Š Deployment summary
      run: |
        echo "## ğŸ‰ Render Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Status** | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Environment** | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Service URL** | ${{ secrets.RENDER_SERVICE_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Deployed At** | $(date -u) |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ§ª POST-DEPLOYMENT TESTS
  # ============================================================================
  post-deploy-tests:
    name: ğŸ§ª Post-Deployment Tests
    needs: deploy-render
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ” API Endpoint Tests
      run: |
        SERVICE_URL="${{ secrets.RENDER_SERVICE_URL }}"
        echo "ğŸ§ª Testing API endpoints..."
        
        # Test basic endpoints
        echo "Testing: ${SERVICE_URL}/health"
        curl -f "${SERVICE_URL}/health" || echo "âŒ Health endpoint failed"
        
        echo "Testing: ${SERVICE_URL}/api/health"  
        curl -f "${SERVICE_URL}/api/health" || echo "âŒ API health endpoint failed"
        
        echo "âœ… Post-deployment tests completed"

    - name: ğŸ“ˆ Performance check
      run: |
        SERVICE_URL="${{ secrets.RENDER_SERVICE_URL }}"
        echo "ğŸ“ˆ Performance check..."
        
        # Simple response time test
        RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "${SERVICE_URL}/")
        echo "â±ï¸ Response time: ${RESPONSE_TIME}s"
        
        if (( $(echo "$RESPONSE_TIME < 5.0" | bc -l) )); then
          echo "âœ… Performance check passed"
        else
          echo "âš ï¸ Slow response time detected"
        fi