# ğŸš‚ Railway Deployment Workflow - Fast & Simple
name: Deploy to Railway

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development

jobs:
  # ============================================================================
  # ğŸ—ï¸ BUILD JOB
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“… Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“ˆ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --no-audit --no-fund

    - name: ğŸ”¨ Build application
      run: npm run build

    - name: ğŸ“Š Build summary
      run: |
        echo "âœ… Build completed successfully"
        echo "ğŸ“¦ Build size: $(du -sh dist/ 2>/dev/null || echo 'N/A')"

  # ============================================================================
  # ğŸš‚ RAILWAY DEPLOYMENT - Production
  # ============================================================================
  deploy-railway-production:
    name: ğŸš‚ Deploy to Railway (Production)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: 
      name: railway-production
     
    
    steps:
    - name: ğŸ“… Checkout code
      uses: actions/checkout@v4

    - name: ğŸš‚ Install Railway CLI
      run: |
        npm install -g @railway/cli
        
    - name: ğŸš‚ Set Railway Environment Variables
      run: |
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway variables set NODE_ENV=production
        railway variables set DATABASE_URL="${{ secrets.DATABASE_URL }}"
        railway variables set REDIS_URL="${{ secrets.REDIS_URL }}"
        railway variables set JWT_SECRET="${{ secrets.JWT_SECRET }}"
        railway variables set NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
        railway variables set RAZORPAY_KEY_ID="${{ secrets.RAZORPAY_KEY_ID }}"
        railway variables set RAZORPAY_KEY_SECRET="${{ secrets.RAZORPAY_KEY_SECRET }}"
        railway variables set SENTRY_DSN="${{ secrets.SENTRY_DSN }}"
        railway variables set TYPESENSE_HOST="${{ secrets.TYPESENSE_HOST }}"
        railway variables set TYPESENSE_API_KEY="${{ secrets.TYPESENSE_API_KEY }}"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        
    - name: ğŸš‚ Deploy to Railway
      run: |
        railway up --detach
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: â³ Wait for deployment
      run: |
        echo "â³ Waiting for Railway deployment to complete..."
        sleep 60
        
    - name: ğŸ” Health check
      run: |
        echo "ğŸ” Performing health check..."
        SERVICE_URL="${{ secrets.RAILWAY_PRODUCTION_URL }}"
        
        # Multiple health check attempts
        for i in {1..5}; do
          echo "Health check attempt $i/5..."
          if curl -f -s "${SERVICE_URL}/health" > /dev/null 2>&1; then
            echo "âœ… Health check passed!"
            break
          elif [ $i -eq 5 ]; then
            echo "âš ï¸ Health check failed after 5 attempts"
            # Don't fail the deployment, just warn
          else
            echo "Retrying in 30 seconds..."
            sleep 30
          fi
        done

    - name: ğŸ“Š Deployment summary
      run: |
        echo "## ğŸš‚ Railway Production Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Status** | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Environment** | Production |" >> $GITHUB_STEP_SUMMARY
        echo "| **Service URL** | ${{ secrets.RAILWAY_PRODUCTION_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Service Name** | ${{ secrets.RAILWAY_SERVICE_NAME || 'msme-production' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Deployed At** | $(date -u) |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸš‚ RAILWAY DEPLOYMENT - Staging
  # ============================================================================
  deploy-railway-staging:
    name: ğŸš‚ Deploy to Railway (Staging)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: 
      name: railway-staging
      url: ${{ secrets.RAILWAY_STAGING_URL }}
    
    steps:
    - name: ğŸ“… Checkout code
      uses: actions/checkout@v4

    - name: ğŸš‚ Install Railway CLI
      run: |
        npm install -g @railway/cli
        
    - name: ğŸš‚ Set Railway Staging Environment Variables
      run: |
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway variables set NODE_ENV=staging --environment staging
        railway variables set DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}" --environment staging
        railway variables set REDIS_URL="${{ secrets.STAGING_REDIS_URL }}" --environment staging
        railway variables set JWT_SECRET="${{ secrets.STAGING_JWT_SECRET }}" --environment staging
        railway variables set NEXTAUTH_SECRET="${{ secrets.STAGING_NEXTAUTH_SECRET }}" --environment staging
        railway variables set RAZORPAY_KEY_ID="${{ secrets.STAGING_RAZORPAY_KEY_ID }}" --environment staging
        railway variables set RAZORPAY_KEY_SECRET="${{ secrets.STAGING_RAZORPAY_KEY_SECRET }}" --environment staging
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        
    - name: ğŸš‚ Deploy to Railway Staging
      run: |
        railway up --detach --environment staging
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: ğŸ” Staging health check
      run: |
        echo "ğŸ” Staging health check..."
        SERVICE_URL="${{ secrets.RAILWAY_STAGING_URL }}"
        
        if curl -f "${SERVICE_URL}/health" 2>/dev/null; then
          echo "âœ… Staging service is healthy"
        else
          echo "âš ï¸ Staging health check failed (may still be starting)"
        fi

  # ============================================================================
  # ğŸ§ª POST-DEPLOYMENT TESTS
  # ============================================================================
  railway-tests:
    name: ğŸ§ª Railway Integration Tests
    needs: [deploy-railway-production]
    runs-on: ubuntu-latest
    if: always() && needs.deploy-railway-production.result == 'success'
    
    steps:
    - name: ğŸ” API Tests
      run: |
        SERVICE_URL="${{ secrets.RAILWAY_PRODUCTION_URL }}"
        echo "ğŸ§ª Testing Railway deployment endpoints..."
        
        # Test API endpoints
        echo "Testing: ${SERVICE_URL}/health"
        curl -f "${SERVICE_URL}/health" || echo "âŒ Health endpoint failed"
        
        echo "Testing: ${SERVICE_URL}/api/health"
        curl -f "${SERVICE_URL}/api/health" || echo "âŒ API health failed"
        
        echo "Testing: ${SERVICE_URL}/api/status"
        curl -f "${SERVICE_URL}/api/status" || echo "âŒ Status endpoint failed"

    - name: ğŸ“ˆ Performance test
      run: |
        SERVICE_URL="${{ secrets.RAILWAY_PRODUCTION_URL }}"
        echo "ğŸ“ˆ Railway performance test..."
        
        # Simple load test
        for i in {1..10}; do
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "${SERVICE_URL}/")
          echo "Request $i: ${RESPONSE_TIME}s"
        done
        
        echo "âœ… Performance test completed"

  # ============================================================================
  # ğŸ”„ RAILWAY DATABASE MIGRATIONS
  # ============================================================================
  railway-migrations:
    name: ğŸ”„ Run Database Migrations
    needs: deploy-railway-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“… Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“ˆ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --no-audit --no-fund

    - name: ğŸ”„ Run migrations
      run: |
        echo "ğŸ”„ Running database migrations..."
        # Run Drizzle migrations
        npx drizzle-kit push --config=drizzle.config.ts
        echo "âœ… Migrations completed"
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: ğŸŒ± Seed database (if needed)
      run: |
        echo "ğŸŒ± Seeding database..."
        # Add your seed script here if you have one
        # npm run seed
        echo "âœ… Database seeding completed"
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      continue-on-error: true
