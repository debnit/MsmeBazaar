# ðŸš€ Render Deployment Guide for MSMEBazaar V2

This guide walks you through deploying your MSMEBazaar V2 monorepo to Render with all microservices.

## ðŸ“‹ **Prerequisites**

### 1. **Accounts & Services**
- [x] GitHub account with repository access
- [x] [Render account](https://render.com) (free tier available)
- [x] [Stripe account](https://stripe.com) with API keys
- [x] [Twilio account](https://twilio.com) with WhatsApp Business API
- [x] [SendGrid account](https://sendgrid.com) with verified domain
- [x] [OpenAI API key](https://openai.com/api)
- [x] AWS account with S3 bucket (optional)

### 2. **Repository Setup**
- [x] Code pushed to GitHub repository
- [x] `render.yaml` in repository root
- [x] All Dockerfiles present in backend services
- [x] Environment variables documented in `.env.example`

---

## ðŸš€ **Step-by-Step Deployment**

### **Step 1: Connect GitHub Repository**

1. **Go to Render Dashboard**
   ```
   https://dashboard.render.com
   ```

2. **Connect GitHub Account**
   - Click "New +" â†’ "Blueprint"
   - Select "Connect GitHub"
   - Authorize Render to access your repositories

3. **Select Repository**
   - Choose your `msmebazaar-v2` repository
   - Render will automatically detect `render.yaml`

### **Step 2: Configure Environment Variables**

Before deploying, set up all required environment variables in Render:

#### **2.1 Database & Cache (Auto-configured)**
These are automatically set by Render services:
- `DATABASE_URL` - Auto-generated by PostgreSQL service
- `REDIS_URL` - Auto-generated by Redis service

#### **2.2 Authentication & Security**
```bash
# JWT Configuration
SECRET_KEY=your-super-secret-jwt-key-here-min-32-chars
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

#### **2.3 Payment Integration**
```bash
# Stripe (Required for payments)
STRIPE_SECRET_KEY=sk_live_your_stripe_secret_key
STRIPE_PUBLISHABLE_KEY=pk_live_your_stripe_publishable_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_your_stripe_publishable_key

# Razorpay (Optional alternative)
RAZORPAY_KEY_ID=rzp_live_your_razorpay_key_id
RAZORPAY_KEY_SECRET=your_razorpay_secret
```

#### **2.4 Communication Services**
```bash
# Twilio (WhatsApp & SMS)
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_twilio_auth_token
WHATSAPP_PHONE_NUMBER=+1234567890

# SendGrid (Email)
SENDGRID_API_KEY=SG.your_sendgrid_api_key
FROM_EMAIL=noreply@msmebazaar.com
```

#### **2.5 External APIs**
```bash
# OpenAI (AI Features)
OPENAI_API_KEY=sk-your_openai_api_key

# AWS S3 (File Storage)
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
AWS_REGION=ap-south-1
S3_BUCKET_NAME=msmebazaar-documents
```

#### **2.6 Monitoring (Optional)**
```bash
# Google Analytics
GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
VITE_GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX

# Sentry (Error Tracking)
SENTRY_DSN=https://your_sentry_dsn@sentry.io/project_id
VITE_SENTRY_DSN=https://your_sentry_dsn@sentry.io/project_id
```

### **Step 3: Set Environment Variables in Render**

#### **Method 1: Via Environment Variable Groups**
1. Go to "Environment" â†’ "Environment Variable Groups"
2. Create groups for better organization:

**Database Config Group:**
```
DATABASE_URL (auto-populated)
REDIS_URL (auto-populated)
```

**Auth Secrets Group:**
```
SECRET_KEY=your-secret-key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

**Payment Secrets Group:**
```
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
RAZORPAY_KEY_ID=rzp_live_...
RAZORPAY_KEY_SECRET=...
```

**Communication Secrets Group:**
```
TWILIO_ACCOUNT_SID=AC...
TWILIO_AUTH_TOKEN=...
SENDGRID_API_KEY=SG....
WHATSAPP_PHONE_NUMBER=+...
```

**External APIs Group:**
```
OPENAI_API_KEY=sk-...
AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=...
GOOGLE_ANALYTICS_ID=G-...
SENTRY_DSN=https://...
```

#### **Method 2: Per Service Configuration**
For each service, go to "Environment" tab and add relevant variables.

### **Step 4: Deploy Services**

1. **Click "Deploy"**
   - Render will start building all services defined in `render.yaml`
   - Services will be deployed in dependency order

2. **Monitor Deployment**
   - Watch the build logs for each service
   - Services will show as "Live" when deployment succeeds

### **Step 5: Verify Deployment**

#### **5.1 Check Service Health**
Visit health check endpoints for each service:

```bash
# Database & Cache
âœ… PostgreSQL: Check in Render dashboard
âœ… Redis: Check in Render dashboard

# Backend Services
âœ… Auth API: https://msmebazaar-auth-api.onrender.com/health
âœ… MSME API: https://msmebazaar-msme-api.onrender.com/health
âœ… Admin API: https://msmebazaar-admin-api.onrender.com/health
âœ… Payments API: https://msmebazaar-payments-api.onrender.com/health
âœ… WhatsApp Bot: https://msmebazaar-whatsapp-bot.onrender.com/health

# Frontend
âœ… Frontend: https://msmebazaar-frontend.onrender.com
```

#### **5.2 Test API Endpoints**
```bash
# Test auth endpoint
curl https://msmebazaar-auth-api.onrender.com/docs

# Test MSME endpoint
curl https://msmebazaar-msme-api.onrender.com/docs

# Test payments endpoint
curl https://msmebazaar-payments-api.onrender.com/docs
```

#### **5.3 Test Frontend**
1. Visit your frontend URL
2. Check that it loads without errors
3. Verify API connections work
4. Test authentication flow

---

## ðŸ”§ **Advanced Configuration**

### **Custom Domain Setup**

1. **Add Custom Domain**
   - Go to your frontend service
   - Click "Settings" â†’ "Custom Domains"
   - Add your domain (e.g., `msmebazaar.com`)

2. **Configure DNS**
   ```
   Type: CNAME
   Name: www (or @)
   Value: msmebazaar-frontend.onrender.com
   ```

3. **SSL Certificate**
   - Render automatically provisions SSL certificates
   - Wait for DNS propagation (up to 24 hours)

### **Auto-Deploy Setup**

1. **Enable Auto-Deploy**
   - Go to each service â†’ "Settings"
   - Enable "Auto-Deploy"
   - Choose branch (usually `main` or `master`)

2. **Deploy Hooks**
   - Set up webhook URLs for external triggers
   - Configure branch-specific deployments

### **Monitoring & Alerts**

1. **Service Monitoring**
   - Enable health check monitoring
   - Set up alert notifications
   - Configure uptime monitoring

2. **Log Management**
   - Access logs via Render dashboard
   - Set up log retention policies
   - Configure log forwarding (optional)

---

## ðŸš¨ **Troubleshooting**

### **Common Issues & Solutions**

#### **Build Failures**

**Frontend Build Issues:**
```bash
# Check Node.js version
node --version  # Should be 18+

# Clear npm cache
npm cache clean --force

# Reinstall dependencies
rm -rf node_modules package-lock.json
npm install
```

**Backend Build Issues:**
```bash
# Check Python version
python --version  # Should be 3.11+

# Update pip
pip install --upgrade pip

# Reinstall requirements
pip install -r requirements.txt
```

#### **Environment Variable Issues**

**Missing Variables:**
- Check Render dashboard â†’ Service â†’ Environment
- Verify variable names match exactly
- Ensure no trailing spaces in values

**Database Connection:**
```bash
# Check DATABASE_URL format
postgresql://username:password@host:port/database

# Test connection
psql $DATABASE_URL -c "SELECT 1;"
```

#### **Service Communication Issues**

**Inter-service URLs:**
- Use internal service names: `msmebazaar-auth-api`
- Check service discovery configuration
- Verify network policies

#### **Health Check Failures**

**Debug Health Endpoints:**
```bash
# Check individual service health
curl -v https://your-service.onrender.com/health

# Check service logs
# Go to Render dashboard â†’ Service â†’ Logs
```

### **Performance Optimization**

#### **Frontend Optimization**
```bash
# Enable production build optimizations
VITE_BUILD_MODE=production
NODE_ENV=production

# Enable compression
# Render automatically handles gzip compression
```

#### **Backend Optimization**
```bash
# Use production ASGI server settings
uvicorn main:app --workers 2 --host 0.0.0.0 --port $PORT

# Enable database connection pooling
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

---

## ðŸ“Š **Monitoring & Maintenance**

### **Health Monitoring**

#### **Service Health Dashboard**
Create a simple monitoring dashboard:

```bash
# Check all services
services=(
  "https://msmebazaar-auth-api.onrender.com/health"
  "https://msmebazaar-msme-api.onrender.com/health"
  "https://msmebazaar-admin-api.onrender.com/health"
  "https://msmebazaar-payments-api.onrender.com/health"
  "https://msmebazaar-whatsapp-bot.onrender.com/health"
)

for service in "${services[@]}"; do
  echo "Checking $service"
  curl -s "$service" | jq '.status'
done
```

#### **Automated Health Checks**
Set up external monitoring with:
- [UptimeRobot](https://uptimerobot.com) (free)
- [Pingdom](https://pingdom.com)
- [StatusPage.io](https://statuspage.io)

### **Log Management**

#### **Centralized Logging**
```bash
# Access logs via Render CLI
render logs --service msmebazaar-auth-api --tail

# Or via dashboard
# Go to Service â†’ Logs tab
```

#### **Error Tracking**
With Sentry integration:
```python
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn=os.getenv("SENTRY_DSN"),
    integrations=[FastApiIntegration()],
    traces_sample_rate=1.0,
)
```

### **Backup & Recovery**

#### **Database Backups**
```bash
# Render automatically handles PostgreSQL backups
# Access via dashboard â†’ PostgreSQL service â†’ Backups
```

#### **Code Backup**
```bash
# Ensure code is backed up in GitHub
git push origin main

# Tag releases
git tag -a v2.0.0 -m "Production release v2.0.0"
git push origin v2.0.0
```

---

## ðŸŽ¯ **Production Checklist**

### **Pre-Launch Checklist**

- [ ] All services deployed and healthy
- [ ] Environment variables configured
- [ ] Custom domain configured with SSL
- [ ] Database migrations completed
- [ ] External service integrations tested
- [ ] Monitoring and alerts configured
- [ ] Backup strategy implemented
- [ ] Performance testing completed
- [ ] Security audit completed

### **Post-Launch Checklist**

- [ ] Monitor service health for 24 hours
- [ ] Verify all user flows work correctly
- [ ] Check payment processing
- [ ] Test notification systems
- [ ] Monitor error rates and performance
- [ ] Verify backups are working
- [ ] Update documentation
- [ ] Train team on new deployment

---

## ðŸ†˜ **Support & Resources**

### **Render Documentation**
- [Render Docs](https://render.com/docs)
- [Blueprint Reference](https://render.com/docs/blueprint-spec)
- [Environment Variables](https://render.com/docs/environment-variables)

### **Community Support**
- [Render Community](https://community.render.com)
- [GitHub Issues](https://github.com/render-oss/render-examples)
- [Discord](https://discord.gg/render)

### **Emergency Contacts**
- **Technical Issues**: Create ticket in Render dashboard
- **Billing Issues**: billing@render.com
- **Security Issues**: security@render.com

---

## ðŸŽ‰ **Success!**

Your MSMEBazaar V2 application is now live on Render! 

**Access URLs:**
- **Frontend**: https://msmebazaar-frontend.onrender.com
- **API Docs**: https://msmebazaar-auth-api.onrender.com/docs
- **Admin Panel**: https://msmebazaar-frontend.onrender.com/admin

**Next Steps:**
1. Configure your custom domain
2. Set up monitoring and alerts
3. Test all user workflows
4. Launch to your users! ðŸš€