# VyapaarMitra Production Deployment Guide

## üöÄ Overview

This guide provides step-by-step instructions for deploying VyapaarMitra to production on **vyapaarmitra.in** using Railway (preferred for APIs) and Render (for full-stack deployment).

### Architecture Overview

```
vyapaarmitra.in (Main Website)
‚îú‚îÄ‚îÄ admin.vyapaarmitra.in (Admin Dashboard)
‚îú‚îÄ‚îÄ api.vyapaarmitra.in (API Gateway)
‚îî‚îÄ‚îÄ Services:
    ‚îú‚îÄ‚îÄ Web Frontend (Next.js)
    ‚îú‚îÄ‚îÄ Auth API (FastAPI)
    ‚îú‚îÄ‚îÄ MSME API (FastAPI)
    ‚îú‚îÄ‚îÄ Valuation API (FastAPI)
    ‚îú‚îÄ‚îÄ PostgreSQL Database
    ‚îî‚îÄ‚îÄ Redis Cache
```

## üìã Prerequisites

### 1. Domain Configuration

**Required DNS Records:**
```
Type    Name    Value                           TTL
A       @       [Railway/Render IP]            3600
CNAME   www     vyapaarmitra.in                3600
CNAME   admin   [admin-service-url]            3600
CNAME   api     [api-service-url]              3600
```

### 2. Environment Secrets

Create these secrets in your deployment platform:

**Required Secrets:**
- `JWT_SECRET` - JWT signing key (32+ characters)
- `NEXTAUTH_SECRET` - NextAuth secret (32+ characters)
- `ADMIN_SECRET_KEY` - Admin authentication key
- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string
- `TWILIO_ACCOUNT_SID` - Twilio SMS service
- `TWILIO_AUTH_TOKEN` - Twilio authentication
- `SENDGRID_API_KEY` - Email service
- `AWS_ACCESS_KEY_ID` - File upload service
- `AWS_SECRET_ACCESS_KEY` - AWS secret key
- `SENTRY_DSN` - Error monitoring

## üöÇ Option 1: Railway Deployment (Recommended for APIs)

### Step 1: Install Railway CLI

```bash
npm install -g @railway/cli
```

### Step 2: Login and Initialize

```bash
railway login
railway init vyapaarmitra
```

### Step 3: Add Database Plugins

```bash
railway add postgresql
railway add redis
```

### Step 4: Deploy Services

```bash
# Deploy Auth API
railway service create auth-api
cd msmebazaar-v2/apps/auth-api
railway up

# Deploy MSME API  
railway service create msme-api
cd ../msme-api
railway up

# Deploy Valuation API
railway service create valuation-api
cd ../valuation-api
railway up

# Deploy Web Frontend
railway service create web
cd ../web
railway up

# Deploy Admin Dashboard
railway service create admin-dashboard
cd ../../../admin-dashboard/backend
railway up
```

### Step 5: Configure Environment Variables

```bash
# Auth API Environment
railway variables set JWT_SECRET=your_jwt_secret_here
railway variables set JWT_ALGORITHM=HS256
railway variables set TWILIO_ACCOUNT_SID=your_twilio_sid
railway variables set SENDGRID_API_KEY=your_sendgrid_key
railway variables set SENDGRID_FROM_EMAIL=noreply@vyapaarmitra.in

# Web Frontend Environment
railway variables set NEXTAUTH_URL=https://vyapaarmitra.in
railway variables set NEXT_PUBLIC_API_URL=https://api.vyapaarmitra.in
```

### Step 6: Configure Custom Domains

```bash
# Main website
railway domain add vyapaarmitra.in --service web

# Admin dashboard
railway domain add admin.vyapaarmitra.in --service admin-dashboard

# API gateway
railway domain add api.vyapaarmitra.in --service auth-api
```

## üé® Option 2: Render Deployment (Full-Stack)

### Step 1: Connect Repository

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click "New" ‚Üí "Blueprint"
3. Connect your GitHub repository
4. Select the `render.yaml` file

### Step 2: Configure Environment Variables

**In Render Dashboard, set these environment variables:**

```bash
# Database (auto-generated by Render)
DATABASE_URL=postgresql://...

# Authentication
JWT_SECRET=your_jwt_secret_here
NEXTAUTH_SECRET=your_nextauth_secret_here
ADMIN_SECRET_KEY=your_admin_secret_here

# External Services
TWILIO_ACCOUNT_SID=your_twilio_sid
TWILIO_AUTH_TOKEN=your_twilio_token
SENDGRID_API_KEY=your_sendgrid_key
AWS_ACCESS_KEY_ID=your_aws_key
AWS_SECRET_ACCESS_KEY=your_aws_secret

# Domain Configuration
NEXTAUTH_URL=https://vyapaarmitra.in
NEXT_PUBLIC_API_URL=https://api.vyapaarmitra.in
```

### Step 3: Deploy Services

1. Click "Create New Blueprint"
2. Wait for all services to deploy
3. Verify health checks pass

## üåê Domain Configuration

### Step 1: Purchase Domain

1. Purchase `vyapaarmitra.in` from a registrar (GoDaddy, Namecheap, etc.)
2. Access domain management panel

### Step 2: Configure DNS Records

**For Railway Deployment:**
```
Type    Name    Value                                   TTL
A       @       [Get from Railway dashboard]           3600
CNAME   www     vyapaarmitra.in                        3600
CNAME   admin   vyapaarmitra-admin-dashboard.up.railway.app  3600
CNAME   api     vyapaarmitra-auth-api.up.railway.app    3600
```

**For Render Deployment:**
```
Type    Name    Value                                   TTL
A       @       [Get from Render dashboard]            3600
CNAME   www     vyapaarmitra.in                        3600
CNAME   admin   vyapaarmitra-admin.onrender.com        3600
CNAME   api     vyapaarmitra-auth-api.onrender.com     3600
```

### Step 3: SSL Certificate Setup

**Railway:**
- SSL certificates are automatically generated
- Verify HTTPS works after DNS propagation

**Render:**
- SSL certificates are automatically generated
- Verify HTTPS works after DNS propagation

## üóÑÔ∏è Database Setup

### Step 1: Database Migration

```bash
# Install dependencies
npm ci

# Set database URL
export DATABASE_URL="postgresql://..."

# Run migrations
npx prisma migrate deploy

# Seed initial data (optional)
npx prisma db seed
```

### Step 2: Verify Database Connection

```bash
# Test connection
npx prisma studio

# Check tables
npx prisma db pull
```

## üîç Health Checks and Verification

### Step 1: Service Health Checks

```bash
# Main website
curl -f https://vyapaarmitra.in/api/health

# Admin dashboard
curl -f https://admin.vyapaarmitra.in/api/health

# Auth API
curl -f https://api.vyapaarmitra.in/health

# Metrics endpoint
curl -f https://api.vyapaarmitra.in/metrics
```

### Step 2: End-to-End Testing

```bash
# Test user registration
curl -X POST https://api.vyapaarmitra.in/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@vyapaarmitra.in","password":"password123"}'

# Test login
curl -X POST https://api.vyapaarmitra.in/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@vyapaarmitra.in","password":"password123"}'
```

## üìä Monitoring Setup

### Step 1: Prometheus Metrics

Access Prometheus dashboard:
- URL: `https://api.vyapaarmitra.in/metrics`
- Verify metrics are being collected

### Step 2: Error Monitoring

Configure Sentry:
```bash
# Set Sentry DSN
export SENTRY_DSN=your_sentry_dsn_here
```

### Step 3: Uptime Monitoring

Set up external monitoring:
- UptimeRobot
- Pingdom
- StatusPage

## üöÄ CI/CD Pipeline

### Step 1: GitHub Secrets

Configure these secrets in GitHub repository:

```
RAILWAY_TOKEN=your_railway_token
RENDER_API_KEY=your_render_api_key
DATABASE_URL=your_production_db_url
SLACK_WEBHOOK_URL=your_slack_webhook
NOTIFICATION_EMAIL=admin@vyapaarmitra.in
```

### Step 2: Deployment Triggers

**Automatic deployments:**
- `main` branch ‚Üí Railway (staging)
- `release` branch ‚Üí Render (production)

### Step 3: Pipeline Verification

```bash
# Check workflow status
gh workflow run vyapaarmitra-deploy.yml

# View logs
gh run list --workflow=vyapaarmitra-deploy.yml
```

## üîß Performance Optimization

### Step 1: CDN Configuration

**CloudFlare Setup:**
1. Add site to CloudFlare
2. Update nameservers
3. Enable CDN, caching, and security features

### Step 2: Database Optimization

```sql
-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_businesses_status ON businesses(status);
CREATE INDEX IF NOT EXISTS idx_valuations_created_at ON valuations(created_at);
```

### Step 3: Caching Strategy

```bash
# Redis configuration
REDIS_URL=redis://...
CACHE_TTL=3600
CACHE_PREFIX=vyapaarmitra_
```

## üõ°Ô∏è Security Configuration

### Step 1: Environment Security

```bash
# Secure environment variables
JWT_SECRET=generated_32_character_string
ADMIN_SECRET_KEY=generated_admin_key
NEXTAUTH_SECRET=generated_nextauth_secret
```

### Step 2: Rate Limiting

NGINX configuration includes:
- 50 requests/second for general traffic
- 10 requests/second for API calls
- 5 requests/minute for login attempts

### Step 3: Security Headers

All services include:
- HSTS (Strict-Transport-Security)
- CSRF protection
- XSS protection
- Content Security Policy

## üÜò Troubleshooting

### Common Issues

**1. SSL Certificate Issues**
```bash
# Check certificate
openssl s_client -connect vyapaarmitra.in:443

# Force renewal (if using Let's Encrypt)
certbot renew --force-renewal
```

**2. Database Connection Issues**
```bash
# Test connection
psql $DATABASE_URL -c "SELECT 1;"

# Check connection pool
railway logs --service postgres
```

**3. Domain Not Resolving**
```bash
# Check DNS propagation
dig vyapaarmitra.in
nslookup vyapaarmitra.in

# Test all subdomains
dig admin.vyapaarmitra.in
dig api.vyapaarmitra.in
```

**4. Service Health Check Failures**
```bash
# Check service logs
railway logs --service auth-api
render logs --service vyapaarmitra-auth-api

# Verify environment variables
railway variables list
```

### Emergency Rollback

```bash
# Railway rollback
railway rollback --service auth-api

# Render rollback
render deploy rollback --service vyapaarmitra-auth-api
```

## üìà Post-Deployment Checklist

- [ ] All health checks passing
- [ ] SSL certificates active on all domains
- [ ] Database migrations completed
- [ ] Environment variables configured
- [ ] External services connected (Twilio, SendGrid, AWS)
- [ ] Monitoring and alerting configured
- [ ] Performance benchmarks met
- [ ] Security scans completed
- [ ] Backup strategy implemented
- [ ] Team access configured
- [ ] Documentation updated

## üìû Support Contacts

**Technical Issues:**
- Email: tech@vyapaarmitra.in
- Slack: #vyapaarmitra-tech

**Infrastructure:**
- Railway Support: https://railway.app/help
- Render Support: https://render.com/docs/support

---

**üéâ Congratulations! VyapaarMitra is now live on vyapaarmitra.in**